<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>MCGQS</title>

    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jQuery & Moment.js -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <!-- Date Range Picker -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <!-- Alpine.js -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

</head>

<body class="bg-gray-50 p-10 max-[425px]:p-4" x-data="{ 
                open: false, 
                selectedChart: 'bar', 
            }">

    <h1 class="text-3xl font-bold mb-8 text-center text-gray-800">Live Entity Counts</h1>

    <!-- Tabs -->
    <div class="flex justify-center mb-6 space-x-4">
        <button id="weeklyBtn" class="px-4 py-2 bg-blue-500 text-white rounded shadow">Weekly</button>
        <button id="monthlyBtn" class="px-4 py-2 bg-gray-300 text-gray-700 rounded shadow">Monthly</button>
        <button id="yearlyBtn" class="px-4 py-2 bg-gray-300 text-gray-700 rounded shadow">Yearly</button>
    </div>
    <div class="flex items-end justify-between max-w-6xl mx-auto mb-6 gap-6">
        <!-- Chart Selection -->
        <div class="w-full ">
            <div id="multiselect" class="relative">
                <div id="selected-items" class="flex flex-wrap gap-1 mb-1"></div>
                <div id="dropdown-toggle"
                    class="cursor-pointer flex items-center border rounded px-2 py-2 bg-white cursor-pointer">
                    <input type="text" id="dropdown-input" class="w-full focus:outline-none"
                        placeholder="Select entitiesâ€¦" readonly />
                    <svg class="w-4 h-4 ml-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>
                <ul id="dropdown-list"
                    class="absolute left-0 right-0 mt-1 bg-white border rounded shadow max-h-50 overflow-auto hidden z-10">
                </ul>
            </div>
        </div>
        <!-- Entity selection -->
        <div class="flex items-center justify-center">
            <div class="relative">
                <button @click="open = !open"
                    class="flex items-center space-x-2 rounded border bg-white px-4 py-2 shadow">
                    <span x-text="selectedChart" id="chartTypeDropdownContainer"></span>
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>
                <div x-show="open" @click.outside="open = false"
                    class="absolute z-10 mt-2 w-48 rounded border bg-white shadow">
                    <div class="divide-y divide-gray-100">
                        <a href="#" @click.prevent="selectedChart = 'bar'; open = false;  "
                            :class="selectedChart === 'bar' ? 'bg-blue-100 text-blue-800 font-semibold' : ''"
                            class="block px-4 py-2 hover:bg-gray-100"> Bar </a>

                        <a href="#" @click.prevent="selectedChart = 'line'; open = false;  "
                            :class="selectedChart === 'line' ? 'bg-blue-100 text-blue-800 font-semibold' : ''"
                            class="block px-4 py-2 hover:bg-gray-100"> Line </a>

                        <a href="#" @click.prevent="selectedChart = 'area'; open = false;  "
                            :class="selectedChart === 'area' ? 'bg-blue-100 text-blue-800 font-semibold' : ''"
                            class="block px-4 py-2 hover:bg-gray-100"> Area </a>
                        <a href="#" @click.prevent="selectedChart = 'stackedBar'; open = false;  "
                            :class="selectedChart === 'stackedBar' ? 'bg-blue-100 text-blue-800 font-semibold' : ''"
                            class="block px-4 py-2 hover:bg-gray-100">Stacked Bar</a>

                        <a href="#" @click.prevent="selectedChart = 'spline'; open = false;  "
                            :class="selectedChart === 'spline' ? 'bg-blue-100 text-blue-800 font-semibold' : ''"
                            class="block px-4 py-2 hover:bg-gray-100">Spline</a>

                        <a href="#" @click.prevent="selectedChart = 'step'; open = false;  "
                            :class="selectedChart === 'step' ? 'bg-blue-100 text-blue-800 font-semibold' : ''"
                            class="block px-4 py-2 hover:bg-gray-100">Step</a>
                        <a href="#" @click.prevent="selectedChart = 'comboBar'; open = false;  "
                            :class="selectedChart === 'comboBar' ? 'bg-blue-100 text-blue-800 font-semibold' : ''"
                            class="block px-4 py-2 hover:bg-gray-100">Combo Bar</a>
                    </div>
                </div>
            </div>
        </div>
    </div>




    <!-- Date Range + Format -->
    <div class="flex justify-center items-center mb-6 space-x-4">
        <input id="dateRange" type="text" class="border px-3 py-2 rounded w-64 text-center"
            placeholder="Select Date Range" />

        <div x-data="{ open: false, selected: 'Yearly' }" class="relative">
            <button @click="open = !open" class="bg-white border px-4 py-2 rounded shadow flex items-center space-x-2">
                <span x-text="selected" id="selectedFormatInRange"></span>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </button>
            <div x-show="open" @click.outside="open = false"
                class="absolute z-10 mt-2 w-48 bg-white border rounded shadow">
                <div class="divide-y divide-gray-100">
                    <a href="#" @click.prevent="selected='Weekly';open=false"
                        :class="selected==='Weekly'?'bg-blue-100 text-blue-800 font-semibold':''"
                        class="block px-4 py-2 hover:bg-gray-100">Weekly</a>
                    <a href="#" @click.prevent="selected='Monthly';open=false"
                        :class="selected==='Monthly'?'bg-blue-100 text-blue-800 font-semibold':''"
                        class="block px-4 py-2 hover:bg-gray-100">Monthly</a>
                    <a href="#" @click.prevent="selected='Yearly';open=false"
                        :class="selected==='Yearly'?'bg-blue-100 text-blue-800 font-semibold':''"
                        class="block px-4 py-2 hover:bg-gray-100">Yearly</a>
                </div>
            </div>
        </div>

        <button id="viewRangeBtn" class="bg-purple-600 text-white px-4 py-2 rounded shadow">
            View Range
        </button>
    </div>

    <!-- Loader & No-Data -->
    <div id="loader" class="w-full max-w-6xl mx-auto animate-pulse hidden">
        <div class="flex items-end space-x-2 w-full h-80">
            <div class="bg-gray-300 rounded w-full" style="height:30%"></div>
            <div class="bg-gray-300 rounded w-full" style="height:60%"></div>
            <div class="bg-gray-300 rounded w-full" style="height:90%"></div>
            <div class="bg-gray-300 rounded w-full" style="height:50%"></div>
            <div class="bg-gray-300 rounded w-full" style="height:75%"></div>
            <div class="bg-gray-300 rounded w-full" style="height:40%"></div>
        </div>
    </div>
    <div id="noDataMessage"
        class="w-full flex items-center justify-center max-w-6xl mx-auto text-gray-500 text-lg mt-10 hidden">
        <p>No data available.</p>
    </div>

    <!-- Six-Chart Grid -->
    <div id="chartGrid" class="hidden grid grid-cols-1 max-w-6xl mx-auto">

        <div id="comboChartContainer" :class="{ 'h-0 opacity-0': selectedChart !== 'comboBar' }">
            <h2 class="text-xl font-semibold mb-2 text-center">Combo Chart</h2>
            <div id="comboChart" class="w-full h-80"></div>
        </div>
        <div id="barChartContainer" :class="{ 'h-0 opacity-0': selectedChart !== 'bar' }">
            <h2 class="text-xl font-semibold mb-2 text-center">Bar</h2>
            <div id="barChart" class="w-full h-80"></div>
        </div>
        <div id="lineChartContainer" :class="{ 'h-0 opacity-0': selectedChart !== 'line' }" >
            <h2 class="text-xl font-semibold mb-2 text-center">Line</h2>
            <div id="lineChart" class="w-full h-80"></div>
        </div>
        <div id="areaChartContainer" :class ="{ 'h-0 opacity-0': selectedChart !== 'area' }">
            <h2 class="text-xl font-semibold mb-2 text-center">Area</h2>
            <div id="areaChart" class="w-full h-80"></div>
        </div>
        <div id="stackedBarChartContainer" :class ="{ 'h-0 opacity-0': selectedChart !== 'stackedBar' }">
            <h2 class="text-xl font-semibold mb-2 text-center">Stacked Bar</h2>
            <div id="stackedBarChart" class="w-full h-80"></div>
        </div>
        <div id="splineChartContainer" :class  ="{ 'h-0 opacity-0': selectedChart !== 'spline' }">
            <h2 class="text-xl font-semibold mb-2 text-center">Spline</h2>
            <div id="splineChart" class="w-full h-80"></div>
        </div>
        <div id="stepChartContainer" :class ="{ 'h-0 opacity-0': selectedChart !== 'step' }">
            <h2 class="text-xl font-semibold mb-2 text-center">Step</h2>
            <div id="stepChart" class="w-full h-80"></div>
        </div>
    </div>

    <script>
        const apiKey = "zeYfVRNaPP_E-fQxxHelQ";
        const visitorRefferalSource = 'Gallagher Melbourne';
        const wsUrl = `wss://mcgqs.vitalstats.app/api/v1/graphql?apiKey=${apiKey}`;
        const restUrl = `https://mcgqs.vitalstats.app/api/v1/graphql?apiKey=${apiKey}`;
        // "Contacts", "Properties","PartnerLinks"
        const entities = ["Jobs", "Completed Jobs"];
        const colors = { Jobs: "#3b82f6", "Completed Jobs": "#10b981" };

        let readyCount = 0, keepAliveInterval;
        let tracesBar = [], tracesLine = [], tracesArea = [],
            tracesStacked = [], tracesSpline = [], tracesStep = [];
        let currentGranularity = "weekly", selectedStart, selectedEnd;

        const commonLayout = {
            yaxis: { title: "Count" },
            legend: { orientation: "h", x: 0, xanchor: "left", y: 1.15, yanchor: "top" },
            margin: { t: 60, l: 60, r: 30, b: 120 }, barmode: "group"
        };
        const stackedLayout = { ...commonLayout, barmode: "stack" };

        function buildSubscriptionQuery(entity, granularity) {
             const target = entity === "Completed Jobs" ? "Jobs" : entity;
            let B = "X_WEEK_BEGIN", E = "X_WEEK_END", F = "DAY";
            if (granularity === "monthly") { B = "X_MONTH_BEGIN"; E = "X_MONTH_END"; F = "Week-WK"; }
            if (granularity === "yearly") { B = "X_YEAR_BEGIN"; E = "X_YEAR_END"; F = "MONTH"; } 
            const referralFilter = entity === "Jobs" || "Completed Jobs"
                ? `{andWhere: {Referral_Source: [{where: {Company: [{ where: { name: "Gallagher Melbourne" } }]}}]}}`
                : "";
                 const statusFilter = entity === "Completed Jobs" 
                ? `{andWhere:{job_status:"Report Sent"}}`
                : "";
            return {
                query: `
          subscription sub${target}($${B}:TimestampSecondsScalar,$${E}:TimestampSecondsScalar){
            subscribeToCalc${target}(query:[
              {where:{created_at:$${B},_OPERATOR_:gte}} 
              {andWhere:{created_at:$${E},_OPERATOR_:lte}} 
               ${statusFilter} 
             ${referralFilter} 
            ]){
              totalCount:count(args:[{field:["id"]}])
              bucket:field(arg:["created_at"])@dateFormat(value:"${F}")
            }
          }`,
                variables: { [B]: 0, [E]: 0 }
            };
        }

        // â€” live websocket loader â€”
        function initializeSocket(entity, granularity) {
            const socket = new WebSocket(wsUrl, "vitalstats");
            socket.onopen = () => {
                keepAliveInterval = setInterval(() => {
                    if (socket.readyState === WebSocket.OPEN)
                        socket.send(JSON.stringify({ type: "KEEP_ALIVE" }));
                }, 28000);

                socket.send(JSON.stringify({ type: "CONNECTION_INIT" }));
                const { query, variables } = buildSubscriptionQuery(entity, granularity);
                socket.send(JSON.stringify({ id: `sub_${entity}`, type: "GQL_START", payload: { query, variables } }));
            };
            socket.onmessage = e => {
                const d = JSON.parse(e.data);
                if (d.type === "GQL_DATA" && d.payload?.data) {
                    const rows = Object.values(d.payload.data)[0] || [];
                    const x = [], y = [];
                    rows.forEach(r => { x.push(r.bucket); y.push(r.totalCount || 0); });
                    const clr = colors[entity] || "#999";
                    tracesBar.push({ x, y, name: entity, type: "bar", marker: { color: clr } });
                    tracesLine.push({ x, y, name: entity, type: "scatter", mode: "lines", marker: { color: clr } });
                    tracesArea.push({ x, y, name: entity, type: "scatter", mode: "lines", fill: "tozeroy", marker: { color: clr } });
                    tracesStacked.push({ x, y, name: entity, type: "bar", marker: { color: clr } });
                    tracesSpline.push({ x, y, name: entity, type: "scatter", mode: "lines", line: { shape: "spline" }, marker: { color: clr } });
                    tracesStep.push({ x, y, name: entity, type: "scatter", mode: "lines", line: { shape: "hv" }, marker: { color: clr } });
                    readyCount++;
                    if (readyCount === entities.length) {
                        clearInterval(keepAliveInterval);
                        document.getElementById("loader").classList.add("hidden");
                        const hasData = tracesBar.some(t => t.y.some(v => v > 0));
                        if (hasData) {
                            document.getElementById("chartGrid").classList.remove("hidden");
                            Plotly.newPlot("barChart", tracesBar, commonLayout);
                            Plotly.newPlot("lineChart", tracesLine, commonLayout);
                            Plotly.newPlot("areaChart", tracesArea, commonLayout);
                            Plotly.newPlot("stackedBarChart", tracesStacked, stackedLayout);
                            Plotly.newPlot("splineChart", tracesSpline, commonLayout);
                            Plotly.newPlot("stepChart", tracesStep, commonLayout);
                            Plotly.newPlot("comboChart", tracesBar.concat(tracesLine), commonLayout);
                        } else {
                            document.getElementById("noDataMessage").classList.remove("hidden");
                        }
                    }
                }
            };
            socket.onerror = () => console.error(`WS error ${entity}`);
            socket.onclose = () => clearInterval(keepAliveInterval);
        }

        function loadData(granularity) {
            readyCount = 0;
            tracesBar = []; tracesLine = []; tracesArea = [];
            tracesStacked = []; tracesSpline = []; tracesStep = [];
            document.getElementById("chartGrid").classList.add("hidden");
            document.getElementById("noDataMessage").classList.add("hidden");
            document.getElementById("loader").classList.remove("hidden");
            entities.forEach(e => initializeSocket(e, granularity));
        }

        // â€” custom range loader using WebSocket GraphQL subscriptions â€”
        function loadCustomRange(rangeStartDate, rangeEndDate) {
            // pick your dateFormat token â€” here we hard-code DD,MON,YYYY
            let selectedFormatInRangeFormat = 'Yearly';
            const selectedFormatInRange = document.getElementById("selectedFormatInRange")?.textContent;
            if (selectedFormatInRange === 'Yearly') {
                selectedFormatInRangeFormat = 'MONTH';
            } else if (selectedFormatInRange === 'Monthly') {
                selectedFormatInRangeFormat = 'Week-WK';
            } else if (selectedFormatInRange === 'Weekly') {
                selectedFormatInRangeFormat = 'DAY';
            }
            const dateFormat = selectedFormatInRangeFormat;

            // reset state
            readyCount = 0;
            tracesBar = []; tracesLine = []; tracesArea = [];
            tracesStacked = []; tracesSpline = []; tracesStep = [];
            document.getElementById("chartGrid").classList.add("hidden");
            document.getElementById("noDataMessage").classList.add("hidden");
            document.getElementById("loader").classList.remove("hidden");

            // helper to build the payload
            function buildRangeSub(entity) {
                 const target = entity === "Completed Jobs" ? "Jobs" : entity;
                const statusFilter = entity === "Completed Jobs"
                ? `{andWhere:{job_status:"Report Sent"}}`
                : "";
                 const referralFilter = entity === "Jobs" ||"Completed Jobs"
                    ? `{andWhere: {Referral_Source: [{where: {Company: [{ where: { name: "Gallagher Melbourne" } }]}}]}}`
                    : "";
                return {
                    query: `
                            subscription subscribeToCalc${target}(
                                $rangeStartDate: TimestampSecondsScalar,
                                $rangeEndDate:   TimestampSecondsScalar
                                ) {
                                subscribeToCalc${target}(
                                    query: [
                                        { where:    { created_at: $rangeStartDate, _OPERATOR_: gte } } 
                                        { andWhere: { created_at: $rangeEndDate,   _OPERATOR_: lte } } 
                                         ${statusFilter} 
                                         ${referralFilter}
                                    ]
                                ) {
                                    totalCount: count(args:[{ field:["id"] }])
                                    Date_Added:  field(arg:["created_at"]) @dateFormat(value:"${dateFormat}")
                                }
                            }
                         `,
                    variables: { rangeStartDate, rangeEndDate }
                };
            }

            // open one socket per entity
            entities.forEach(entity => {
                const socket = new WebSocket(wsUrl, "vitalstats");

                socket.onopen = () => {
                    // start keep-alive pings
                    keepAliveInterval = setInterval(() => {
                        if (socket.readyState === WebSocket.OPEN)
                            socket.send(JSON.stringify({ type: "KEEP_ALIVE" }));
                    }, 28000);

                    // kick off subscription
                    socket.send(JSON.stringify({ type: "CONNECTION_INIT" }));
                    const payload = buildRangeSub(entity);
                    socket.send(JSON.stringify({
                        id: `range_${entity}`,
                        type: "GQL_START",
                        payload
                    }));
                };

                socket.onmessage = event => {
                    const data = JSON.parse(event.data);
                    if (data.type === "GQL_DATA" && data.payload?.data) {
                        const rows = data.payload.data[`subscribeToCalc${entity}`] || [];
                        const x = [], y = [];
                        rows.forEach(r => {
                            x.push(r.Date_Added);
                            y.push(r.totalCount || 0);
                        });

                        const clr = colors[entity] || "#999";
                        tracesBar.push({ x, y, name: entity, type: "bar", marker: { color: clr } });
                        tracesLine.push({ x, y, name: entity, type: "scatter", mode: "lines", marker: { color: clr } });
                        tracesArea.push({ x, y, name: entity, type: "scatter", mode: "lines", fill: "tozeroy", marker: { color: clr } });
                        tracesStacked.push({ x, y, name: entity, type: "bar", marker: { color: clr } });
                        tracesSpline.push({ x, y, name: entity, type: "scatter", mode: "lines", line: { shape: "spline" }, marker: { color: clr } });
                        tracesStep.push({ x, y, name: entity, type: "scatter", mode: "lines", line: { shape: "hv" }, marker: { color: clr } });

                        readyCount++;
                        if (readyCount === entities.length) {
                            clearInterval(keepAliveInterval);
                            document.getElementById("loader").classList.add("hidden");

                            const hasData = tracesBar.some(t => t.y.some(v => v > 0));
                            if (hasData) {
                                document.getElementById("chartGrid").classList.remove("hidden");
                                Plotly.newPlot("barChart", tracesBar, commonLayout);
                                Plotly.newPlot("lineChart", tracesLine, commonLayout);
                                Plotly.newPlot("areaChart", tracesArea, commonLayout);
                                Plotly.newPlot("stackedBarChart", tracesStacked, stackedLayout);
                                Plotly.newPlot("splineChart", tracesSpline, commonLayout);
                                Plotly.newPlot("stepChart", tracesStep, commonLayout);
                                Plotly.newPlot("comboChart", tracesBar.concat(tracesLine), commonLayout);
                            } else {
                                document.getElementById("noDataMessage").classList.remove("hidden");
                            }
                        }
                    }
                };

                socket.onerror = () => console.error(`WebSocket error for ${entity}`);
                socket.onclose = () => clearInterval(keepAliveInterval);
            });
        }

        // â€” Init & Listeners â€”
        window.addEventListener("DOMContentLoaded", () => {
            loadData(currentGranularity);

            ["weeklyBtn", "monthlyBtn", "yearlyBtn"].forEach(id => {
                document.getElementById(id).addEventListener("click", () => {
                    currentGranularity = id.replace("Btn", "");
                    ["weeklyBtn", "monthlyBtn", "yearlyBtn"].forEach(x => {
                        document.getElementById(x).classList.replace("bg-blue-500", "bg-gray-300");
                        document.getElementById(x).classList.replace("text-white", "text-gray-700");
                    });
                    document.getElementById(id).classList.replace("bg-gray-300", "bg-blue-500");
                    document.getElementById(id).classList.replace("text-gray-700", "text-white");
                    $("#dateRange").val("");
                    loadData(currentGranularity);
                });
            });

            $('#dateRange').daterangepicker({
                opens: 'center', autoUpdateInput: false,
                locale: { cancelLabel: 'Clear', format: 'YYYY-MM-DD' }
            });
            $('#dateRange').on('apply.daterangepicker', function (ev, picker) {
                selectedStart = Math.floor(picker.startDate.toDate().getTime() / 1000);
                selectedEnd = Math.floor(picker.endDate.toDate().getTime() / 1000);
                $(this).val(
                    picker.startDate.format('YYYY-MM-DD')
                    + ' to ' +
                    picker.endDate.format('YYYY-MM-DD')
                );
            });

            $('#dateRange').on('cancel.daterangepicker', function () {
                $(this).val(''); selectedStart = selectedEnd = null;
            });
            $('#viewRangeBtn').on('click', () => {
                if (!selectedStart || !selectedEnd) return alert("Select a valid date range");
                loadCustomRange(selectedStart, selectedEnd);
            });
        });

        // Combobox
        window.addEventListener("DOMContentLoaded", () => {
            const multiselect = document.getElementById("multiselect");
            const toggle = document.getElementById("dropdown-toggle");
            const input = document.getElementById("dropdown-input");
            const list = document.getElementById("dropdown-list");
            const selectedContainer = document.getElementById("selected-items");
            const dropdownEntities = [...entities];
            let selectedEntities = [...entities];

            function populateList() {
                list.innerHTML = "";
                dropdownEntities.forEach(item => {
                    const li = document.createElement("li");
                    li.className = "flex items-center px-2 py-1 hover:bg-gray-100 cursor-pointer";
                    li.addEventListener("click", e => {
                        e.stopPropagation();
                        const idx = selectedEntities.indexOf(item);
                        if (idx > -1) selectedEntities.splice(idx, 1);
                        else selectedEntities.push(item);
                        updateSelected();
                        populateList();
                    });
                    const box = document.createElement("div");
                    box.className = "w-4 h-4 mr-2 border rounded-sm flex items-center justify-center";
                    if (selectedEntities.includes(item)) {
                        box.classList.add("border-blue-600");
                        box.innerHTML = `<svg class="w-3 h-3 text-blue-600" fill="none"
                             stroke="currentColor" viewBox="0 0 24 24">
                           <path stroke-linecap="round" stroke-linejoin="round"
                                 stroke-width="3" d="M5 13l4 4L19 7"/>
                         </svg>`;
                    }
                    li.append(box, document.createTextNode(item));
                    list.appendChild(li);
                });

                const applyLi = document.createElement("li");
                applyLi.className = "px-2 py-2 flex justify-center hover:bg-gray-100 cursor-pointer";
                const applyButton = document.createElement("button");
                applyButton.textContent = "Apply";
                applyButton.className = "bg-blue-600 text-white px-3 py-1 rounded w-full";
                applyButton.addEventListener("click", e => {
                    e.stopPropagation();
                    entities.splice(0, entities.length, ...selectedEntities);
                    list.classList.add("hidden");
                    if (selectedStart && selectedEnd) loadCustomRange(selectedStart, selectedEnd); 
                    else loadData(currentGranularity); 
                    updateSelected();
                });
                applyLi.appendChild(applyButton);
                list.appendChild(applyLi);
            }

            function updateSelected() {
                selectedContainer.innerHTML = "";
                selectedEntities.forEach(item => {
                    const badge = document.createElement("div");
                    badge.className = "flex items-center bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-sm";
                    badge.textContent = item;
                    const remove = document.createElement("span");
                    remove.innerHTML = "Ã—";
                    remove.className = "ml-1 cursor-pointer";
                    remove.addEventListener("click", e => {
                        e.stopPropagation();
                        selectedEntities.splice(selectedEntities.indexOf(item), 1);
                        updateSelected();
                        populateList();
                    });
                    badge.appendChild(remove);
                    selectedContainer.appendChild(badge);
                });
                input.value = selectedEntities.join(", ");
            }

            function openDropdown() {
                populateList();
                list.classList.remove("hidden");
            }

            toggle.addEventListener("click", e => { e.stopPropagation(); openDropdown(); });
            input.addEventListener("click", e => { e.stopPropagation(); openDropdown(); });
            document.addEventListener("click", e => {
                if (!multiselect.contains(e.target)) list.classList.add("hidden");
            });

            updateSelected();
        });

    </script>
</body>

</html>